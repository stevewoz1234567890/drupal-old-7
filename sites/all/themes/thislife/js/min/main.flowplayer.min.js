var isMobile={Android:function(){return navigator.userAgent.match(/Android/i)&&"undefined"!=typeof AndroidInterface?!0:!1},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)&&"undefined"!=typeof window.webkit&&"undefined"!=typeof window.webkit.messageHandlers?!0:!1}};isMobile.Android()&&(window.addEventListener("talShortcut",function(e){AndroidInterface.talShortcut(JSON.stringify(e.detail))}),window.addEventListener("talPlay",function(e){AndroidInterface.talPlay(JSON.stringify(e.detail))}),window.addEventListener("talGoto",function(e){AndroidInterface.talGoto(JSON.stringify(e.detail))})),isMobile.iOS()&&(window.addEventListener("talShortcut",function(e){window.webkit.messageHandlers.talShortcut.postMessage(JSON.stringify(e.detail))}),window.addEventListener("talPlay",function(e){window.webkit.messageHandlers.talPlay.postMessage(JSON.stringify(e.detail))}),window.addEventListener("talGoto",function(e){window.webkit.messageHandlers.talGoto.postMessage(JSON.stringify(e.detail))}));var formatTimeString=function(e){var t=Math.floor(e/60),a=Math.round(e-60*t),n=10>t?"0"+t:t;return n+=":"+(10>a?"0"+a:a)};!function($){$.fn.matchHeight._maintainScroll=!0,$(document).ready(function(){$("body").addClass("loaded")}),Drupal.behaviors.thislife={attach:function(){}},Drupal.behaviors.thislifePlayer={attach:function(){var e=$("body"),t=$("#site-header"),a=$("#burger"),n=$("#main-menu"),i=!1,o=function(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}};n.on("click",function(e){e.stopPropagation()}),a.on("click",function(t){t.preventDefault(),t.stopPropagation(),i?(i=!1,e.removeClass("open-menu")):(i=!0,e.addClass("open-menu"))}),o()&&e.swipe({swipeRight:function(){i&&(i=!1,e.removeClass("open-menu"))},threshold:20}),e.on("click",function(){i&&(i=!1,e.removeClass("open-menu"))});var l=$("#main"),s=$("#sidebar"),d=$("#top"),r=$("#fplayer"),c=$("#player"),f=c.find(".fp-timeline"),p=c.find(".jp-current-time"),u=c.find(".jp-remaining"),h=c.find("#player-info"),m=$("#share-modal"),v=$("#player-share-modal"),y=0,w=!1,g=!1,k=!1,b=0,C=window.location.pathname+window.location.search,D=$(window),E=0,x=0,S=!1,P=function(){var e=D.width(),t=e>=1024?"desktop":e>=768?"tablet":"mobile";return t},j=P(),A=function(){E=D.scrollTop(),G(),window.requestAnimationFrame(A)},G=function(){!S&&E>0?(S=!0,e.addClass("scrolled")):S&&0>=E&&(S=!1,e.removeClass("scrolled"))},M=function(e){var t=k,a=0;$("a.play-act").removeClass("playing"),h.find(".title").html("").hide(),b="undefined"!=typeof e?e:0,$.each(k.acts,function(e,t){t.number===b&&(a=t.timestamp,h.find(".title").html(t.name).css("display","inline-block"))}),_.seek(a),$("a.play-"+k.episode+"-"+b).addClass("playing")},T=function(e){var t=k,a=0;$("a.play-act").removeClass("playing"),h.find(".episode").html(t.title),h.find(".image").html($("<img/>").attr("src",t.thumbnail)),h.find(".title").html("").hide(),c.find(".jump").remove(),b="undefined"!=typeof e?e:0,"undefined"!=typeof k.acts&&$.each(k.acts,function(e,t){t.number===b&&(a=t.timestamp,h.find(".title").html(t.name).css("display","inline-block"))}),_.load({sources:[{type:"application/x-mpegurl",src:t.stream}]},function(e,t,n){a>0&&t.seek(a)}),$("a.play-"+k.episode+"-"+b).addClass("playing")},H=function(){var e=$("#tal-episode-browse-form");if(e.length){var t=$("#top"),a=$("body"),n=e.find(".modal"),i=e.find("#browse-options"),o=e.find(".form-wrapper-select"),l=$("#type-sort"),s=e.find(".filters"),d=!1,r=!0;t.removeClass("disabled"),l.on("click",function(e){"desktop"!==j&&(l.hasClass("open")||(e.preventDefault(),e.stopPropagation(),l.addClass("open")))}),a.on("click",function(e){l.hasClass("open")&&(l.removeClass("open"),e.preventDefault())}),e.find("a.options").on("click",function(e){e.preventDefault(),t.addClass("open-filters")}),i.on("click","a.close",function(e){e.preventDefault(),t.removeClass("open-filters")}),i.on("click","a.modal",function(e){e.preventDefault();var a=$(this).attr("href"),n=$(a);t.addClass("open-modals"),n.show()}),i.find("a.modal").each(function(){var t=$(this),a=$(this).data("element"),n=e.find("."+a).find("select");t.on("click",function(a){t.hasClass("selected")&&(a.preventDefault(),a.stopPropagation(),t.removeClass("selected").find(".selection .value").text(""),d=!0,e.addClass("dirty"),n.val(0),e.submit())})}),n.each(function(){var a=$(this),n=a.attr("id"),l=i.find("."+n),s=o.filter("."+n),r=a.find(".alpha-nav"),c=a.find(".alpha");a.on("click","header a",function(e){e.preventDefault(),a.hide(),t.removeClass("open-modals")}),r.on("click","a",function(e){var t=$(this).attr("href"),n=$(t);e.preventDefault(),e.stopPropagation(),a.find(".inner > .item-list").animate({scrollTop:n.position().top},250)}),a.on("click",".inner a",function(n){n.preventDefault();var i=$(this).data("value"),o=$(this).data("key"),r=$(this).data("element"),c=e.find("."+r),f=c.find("select");f.val(o),l.addClass("selected").find(".selection .value").text(i),s.addClass("selected").find(".selection .value").text(i),d=!0,e.addClass("dirty"),"desktop"===j?e.submit():(a.hide(),t.removeClass("open-modals"))})}),o.each(function(){var a=$(this);a.on("click","label",function(n){if(n.preventDefault(),a.hasClass("selected"))n.stopPropagation(),a.find("select").val(0),e.submit();else{var i=a.data("target"),o=$("#"+i);t.addClass("open-modals"),o.show()}})}),e.on("submit",function(e){e.preventDefault(),r&&(r=!1,t.addClass("disabled"),$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),dataType:"json",data:$(this).serialize(),success:function(e){t.removeClass("open-modals"),N(e.redirect)}}))})}},O=function(){E=D.scrollTop(),x=D.height(),j=P()},q=function(){$(".contextual-links-wrapper").find("a").addClass("ignore"),$("a.shareout").once("links").addClass("external").on("click",function(e){var t=new CustomEvent("talGoto",{detail:{type:"external",url:$(this).prop("href")}});window.dispatchEvent(t),r.length&&e.preventDefault()}),m.find("a.close").once("links").addClass("ignore").on("click",function(t){t.preventDefault(),e.removeClass("open-share")}),$("a.share").once("links").addClass("ignore").on("click",function(t){t.preventDefault(),e.addClass("open-share")}),v.find("a.close").once("links").addClass("ignore").on("click",function(t){t.preventDefault(),e.removeClass("open-player-share")}),$("a.player-share").once("links").addClass("ignore").on("click",function(t){t.preventDefault(),e.addClass("open-player-share")}),$('a[href]:not([href*="'+window.location.hostname+'"]):not([href^="#"]):not([href^="/"]):not([href^="javascript:"]):not([href^="mailto:"]):not(.cut)').once("links").addClass("external").on("click",function(e){var t=new CustomEvent("talGoto",{detail:{type:"external",url:$(this).prop("href")}});window.dispatchEvent(t),r.length&&e.preventDefault()}),$('a[href*="'+window.location.hostname+'"],[href^="/"]').not(".goto, .play, .ignore").once("links").addClass("internal").on("click",function(e){var t=new CustomEvent("talGoto",{detail:{type:"internal",url:$(this).prop("href")}});window.dispatchEvent(t),r.length&&e.preventDefault()}),$(".node-episode").once("links").each(function(){var e={type:$(this).data("type"),id:$(this).data("id"),episode:$(this).data("episode")};$(this).on("click.special","a.goto-episode",function(t){e.url=$(this).prop("href");var a=new CustomEvent("talGoto",{detail:e});window.dispatchEvent(a),r.length&&t.preventDefault()})}),$(".node-transcript").once("links").each(function(){var e=$(this);$(this).on("click.special","a.goto-episode",function(t){var a={type:"episode",id:e.data("episode-id"),episode:e.data("episode"),url:$(this).prop("href")},n=new CustomEvent("talGoto",{detail:a});window.dispatchEvent(n),r.length&&t.preventDefault()})}),$(".node-act").once("links").each(function(){var e=$(this);$(this).on("click.special","a.goto-act",function(t){var a={type:e.data("type"),id:e.data("id"),episode:e.data("episode"),url:$(this).prop("href")};a.url=$(this).prop("href");var n=new CustomEvent("talGoto",{detail:a});window.dispatchEvent(n),r.length&&t.preventDefault()}),$(this).on("click.special","a.goto-episode",function(t){var a={type:"episode",id:e.data("episode-id"),episode:e.data("episode"),url:$(this).prop("href")},n=new CustomEvent("talGoto",{detail:a});window.dispatchEvent(n),r.length&&t.preventDefault()})}),$(".node-collection").once("links").each(function(){var e={type:$(this).data("type"),id:$(this).data("id")};$(this).on("click.special","a.goto-collection",function(t){e.url=$(this).prop("href");var a=new CustomEvent("talGoto",{detail:e});window.dispatchEvent(a),r.length&&t.preventDefault()})});var t=$("ul.actions");t.find("a.download").off("click").on("click.download",function(e){e.preventDefault()}),$("a.cut").attr("target","_blank"),t.on("click.shortcut","a.cut",function(e){var t=new CustomEvent("talShortcut",{detail:{type:$(this).data("type"),id:$(this).data("id"),url:$(this).prop("href")}});window.dispatchEvent(t)}),$("a.play").off("click").on("click.play",function(t){if(t.preventDefault(),$(this).hasClass("playing"))_.pause();else{if(!e.hasClass("player")&&e.hasClass("node-type-homepage")){var a=new CustomEvent("talGoto",{detail:{type:"internal",url:$(this).prop("href")}});window.dispatchEvent(a)}var a=new CustomEvent("talPlay",{detail:{type:$(this).data("type"),id:$(this).data("id"),episode:$(this).data("episode"),act:$(this).data("act")}});window.dispatchEvent(a)}})},J=function(){q(),H(),Drupal.behaviors.contextualLinks.attach(),Drupal.behaviors.thislifeHeight.attach(),Drupal.behaviors.thislifeAbout.attach(),Drupal.behaviors.thislifeExtras.attach(),"undefined"!=typeof k&&(w?($("a.play-"+k.episode+"-"+b).addClass("playing"),$("a.play-"+k.episode).addClass("playing")):($("a.play-act").removeClass("playing"),$("a.play-"+k.episode).removeClass("playing")))},N=function(a,o,r){var c=a.split("#"),f=c[0],p=c[1],u=$("#header").innerHeight();if("/"===f[0])if(C===f)if(p&&$("#"+p).length){var h=$("#"+p).offset().top;$("html, body").animate({scrollTop:h},0)}else $("html, body").animate({scrollTop:0},0);else $.ajax({url:Drupal.settings.basePath+"goto"+f,cache:!0,data:o,dataType:"json",success:function(a){if(C=f,window.history.pushState&&(r?window.history.replaceState({path:f},"",f):window.history.pushState({path:f},"",f)),d.empty(),s.empty(),l.html(a.main),"undefined"!=typeof a.sidebar&&s.html(a.sidebar),"undefined"!=typeof a.top&&d.html(a.top),"undefined"!=typeof a.color?t.css("background-color",a.color):t.css("background-color",""),n.find("li.active-trail").removeClass("active-trail"),n.find("a.active").removeClass("active"),i=!1,e.removeClass("open-menu player-open"),"undefined"!=typeof a.facebook&&m.find("a.facebook").attr("href",a.facebook),"undefined"!=typeof a.twitter&&m.find("a.twitter").attr("href",a.twitter),"undefined"!=typeof a.mail&&m.find("a.mail").attr("href",a.mail),p&&$("#"+p).length){var o=$("#"+p).offset().top;$("html, body").animate({scrollTop:o},0)}else $("html, body").animate({scrollTop:0},0);var c=$("body").attr("class").split(" ");if($.each(c,function(e,t){0===t.indexOf("page-")&&$("body").removeClass(t),0===t.indexOf("node-")&&$("body").removeClass(t)}),"undefined"!=typeof a.node_type&&$("body").addClass("node-type-"+a.node_type),"undefined"!=typeof a.section){$("body").addClass("page-"+a.section);var u=a.section;"listen"===u&&(u="how-to-listen"),n.find("li."+u).addClass("active-trail")}$("title").text(a.title),J(),"undefined"!=typeof ga&&ga("send","pageview",{page:f,title:a.title})}})};if(q(),H(),$(window).on("load",function(){O()}).on("throttledresize",function(){O()}),O(),window.requestAnimationFrame(A),r.length){g=!0;var _=flowplayer("#fplayer",{key:"$108995865694125",splash:!0,volume:1,clip:{}}).on("load",function(e,t,a){}).on("ready",function(e,t,a){var n=a||t.video,i=n.duration;alert("ready"),$.each(k.acts,function(e,a){if(a.number>0){var n=$("<a/>").addClass("jump").css({left:a.timestamp/i*100+"%"}).on("click",function(){t.seek(a.timestamp)});c.append(n)}})}).on("resume",function(){w=!0,$("body").addClass("player playing"),$("a.play-"+k.episode+"-"+b).addClass("playing"),$("a.play-"+k.episode).addClass("playing")}).on("pause",function(){$("body").removeClass("playing"),w=!1,$("a.play-act").removeClass("playing"),$("a.play-"+k.episode).removeClass("playing")}).on("finish",function(){w=!1,$("body").removeClass("playing"),y=0}).on("progress",function(e,t,a){var n=0;$.each(k.acts,function(e,t){a>=t.timestamp&&(n=t.number)}),n!==b&&($("a.play-act").removeClass("playing"),$.each(k.acts,function(e,t){t.number===n&&(b=t.number,h.find(".title").html(t.name).css("display","inline-block"),"undefined"!=typeof t.byline?h.find(".contributor").html(t.byline):h.find(".contributor").empty(),"undefined"!=typeof t.summary?h.find(".body").html(t.summary):h.find(".body").empty(),q())}),$("a.play-"+k.episode+"-"+b).addClass("playing")),p.text(formatTimeString(a)),u.text(formatTimeString(t.video.duration-a))});$("a.jp-play").on("click",function(e){e.preventDefault(),_.resume()}),$("a.jp-pause").on("click",function(e){e.preventDefault(),_.pause()}),c.find("a.cut").on("click",function(e){if(e.preventDefault(),typeof k!==!1&&"undefined"!=typeof k.episode){var t="https://shortcut.thisamericanlife.org/#/clipping/"+k.episode;if(_.video.time){var a=Math.floor(_.video.time);t+="/"+a}_.pause(),window.open(t,"_blank")}}),$(window).on("talGoto",function(e){var t=e.originalEvent.detail;if("external"===t.type)window.open(t.url,"_blank");else{var a=t.url;"/"!==a[0]&&(a=a.replace(window.location.protocol+"//"+window.location.hostname,"")),a.match(/^\/(user|admin|system)/i)?window.open(t.url,"_self"):"/"===a[0]&&N(a)}}),$(window).bind("popstate",function(){N(window.location.pathname,{},!0)}),$(window).on("talPlay",function(e){var t=e.originalEvent.detail;if("undefined"!=typeof t.type)if($("body").addClass("player"),"episode"===t.type){if("undefined"!=typeof t.episode)if(typeof k===!1||k.episode!==t.episode){if($("#playlist-data").length){var a=JSON.parse($("#playlist-data").html());k=a,"undefined"!=typeof a.facebook&&v.find("a.facebook").attr("href",a.facebook),"undefined"!=typeof a.twitter&&v.find("a.twitter").attr("href",a.twitter),"undefined"!=typeof a.mail&&v.find("a.mail").attr("href",a.mail),T()}}else r.jPlayer("play")}else if("act"===t.type&&"undefined"!=typeof t.episode)if(typeof k===!1||k.episode!==t.episode){if($("#playlist-data").length){var a=JSON.parse($("#playlist-data").html());k=a,"undefined"!=typeof a.facebook&&v.find("a.facebook").attr("href",a.facebook),"undefined"!=typeof a.twitter&&v.find("a.twitter").attr("href",a.twitter),"undefined"!=typeof a.mail&&v.find("a.mail").attr("href",a.mail),T()}}else t.act!==b?M(t.act):r.jPlayer("play")}),c.on("click","a, .jp-progress",function(e){e.stopPropagation()}),c.on("click","a.close",function(t){e.removeClass("player-open")}),c.find("a.jp-rewind").click(function(e){if(e.preventDefault(),g){var t=Math.floor(_.video.time)-10;0>t&&(t=0),_.seek(t)}}),c.find("a.jp-forward").click(function(e){if(e.preventDefault(),g){var t=Math.floor(_.video.time)+30;t<_.video.duration&&_.seek(t)}}),c.find("a.jp-previous").click(function(e){if(e.preventDefault(),g&&k){var t=Math.floor(_.video.time),a=k.acts.slice().reverse();$.each(a,function(e,a){return a.number<=b&&a.timestamp<t?(_.seek(a.timestamp),!1):void 0})}}),c.find("a.jp-next").click(function(e){if(e.preventDefault(),g&&k){var t=Math.floor(_.video.time);$.each(k.acts,function(e,a){return a.number>b&&a.timestamp>t?(_.seek(a.timestamp),!1):void 0})}}),c.on("click",function(){"mobile"===j&&(e.hasClass("player-open")||e.addClass("player-open"))})}l.on("click","a.pager",function(e){e.preventDefault();var t=$(this),a=$(this).attr("href");$.ajax({url:a,cache:!0,dataType:"html",success:function(e){var n=t.parents("ul.pager").parent(".item-list");n.replaceWith(e),Drupal.behaviors.thislifeHeight.attach(),q(),"undefined"!=typeof ga&&ga("send","pageview",{page:a,title:e.title})}})})}},Drupal.behaviors.thislifeAbout={attach:function(){var e=$("#block-tal-about-menu");if(e.length&&(e.on("click",function(t){t.preventDefault(),e.toggleClass("open")}),e.on("click",".content",function(e){e.stopPropagation()}),e.on("click","a",function(t){e.removeClass("open")})),$("body").hasClass("page-about-announcements")){var t=$("#main").find(".node-announcement").slice(0,2);t.matchHeight()}}},Drupal.behaviors.thislifeExtras={attach:function(){if($("body").hasClass("node-type-gallery")){var e=$("#main").find(".node-gallery"),t=e.find("#gallery-slideshow"),a=t.find(".gallery-slide"),n=e.find("figure.file-image"),i=e.find("#gallery-slide-template").html(),o=0,l=n.length,s=$(window),d=s.width(),r=1024,c=0,f=function(){a.removeClass("offset").find(".meta > .inner").removeAttr("style"),c=a.eq(o).find(".meta > .inner").position(),a.addClass("offset").find(".meta > .inner").css("top",c.top)};$(window).on("load",function(){d=s.width()}).on("throttledresize",function(){var e=s.width();r>e&&(t.hide(),a.hide()),d=e,f()}),n.each(function(n){var s=$(this),c={color:e.data("background"),img:s.find("img").attr("src"),width:s.find("img").attr("width"),height:s.find("img").attr("height"),current:n+1,total:l,caption:s.find("figcaption").html()},p=Mustache.to_html(i,c);t.append(p),s.on("click",function(e){d>=r&&(e.preventDefault(),o=n,a.eq(n).show(),t.show(),f())})}),a=t.find(".gallery-slide"),t.on("click","button.close",function(e){e.preventDefault(),t.hide(),a.hide()}),t.on("click","button.prev",function(e){e.preventDefault();var t=o-1;0>t&&(t=l-1),a.hide(),a.eq(t).show(),o=t}),t.on("click","button.next",function(e){e.preventDefault();var t=o+1;t>=l&&(t=0),a.hide(),a.eq(t).show(),o=t}),$(document).keydown(function(e){switch(e.keyCode){case 37:var n=o-1;0>n&&(n=l-1),a.hide(),a.eq(n).show(),o=n;break;case 39:var n=o+1;n>=l&&(n=0),a.hide(),a.eq(n).show(),o=n;break;case 27:t.hide(),a.hide()}})}}},Drupal.behaviors.thislifeHeight={attach:function(){if($("body").hasClass("page-archive")&&$("#main").find(".node.view-teaser").matchHeight(),$("body").hasClass("node-type-video-collection")&&$("#main").find(".node-video.view-collection .content").matchHeight(),$("body").hasClass("node-type-homepage")){var e=$("#main").find(".node-homepage"),t=e.find(".featured");t.length&&t.find(".node.view-featured .inner").matchHeight()}}}}(jQuery);